// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// User Management
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  name          String?
  password      String    // Hashed password
  image         String?
  bio           String?
  
  // Gaming Details
  gamerTag      String?
  discordId     String?
  
  // User Role
  role          UserRole  @default(PLAYER)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  emailVerified DateTime?
  
  // Relations
  registrations EventRegistration[]
  teamMemberships TeamMember[]
  createdTeams  Team[]              @relation("TeamCreator")
  teamInvites   TeamInvite[]
  createdEvents Event[]             @relation("EventCreator")
  seatReservations SeatReservation[]
  notifications Notification[]
  sentAnnouncements Announcement[]  @relation("AnnouncementCreator")
  
  @@map("users")
}

enum UserRole {
  PLAYER
  ADMIN
  ORGANIZER
}

// ==========================================
// Event Management
// ==========================================

model Event {
  id              String   @id @default(cuid())
  name            String
  description     String?  @db.Text
  game            String   // e.g., "Apex Legends", "Valorant"
  
  // Event Details
  startDate       DateTime
  endDate         DateTime?
  registrationStart DateTime
  registrationEnd DateTime
  
  // Capacity & Rules
  maxParticipants Int
  teamSize        Int      @default(1) // 1 for solo, 2+ for teams
  status          EventStatus @default(DRAFT)
  
  // Venue
  venue           String?
  venueAddress    String?
  isOnline        Boolean  @default(false)
  
  // Entry
  entryFee        Float    @default(0)
  prizePool       Float?
  
  // Images
  bannerImage     String?
  thumbnailImage  String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  creatorId       String
  creator         User     @relation("EventCreator", fields: [creatorId], references: [id])
  
  registrations   EventRegistration[]
  seats           Seat[]
  brackets        Bracket[]
  
  @@map("events")
}

enum EventStatus {
  DRAFT
  PUBLISHED
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==========================================
// Registration Management
// ==========================================

model EventRegistration {
  id              String   @id @default(cuid())
  
  // Registration Details
  status          RegistrationStatus @default(PENDING)
  checkInStatus   CheckInStatus      @default(NOT_CHECKED_IN)
  
  // Team Info
  teamId          String?
  team            Team?    @relation(fields: [teamId], references: [id])
  
  // Payment
  paymentStatus   PaymentStatus @default(UNPAID)
  paymentAmount   Float?
  
  // Timestamps
  registeredAt    DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  eventId         String
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, userId])
  @@map("event_registrations")
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
  WAITLIST
  CANCELLED
}

enum CheckInStatus {
  NOT_CHECKED_IN
  CHECKED_IN
  NO_SHOW
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  REFUNDED
}

// ==========================================
// Team Management
// ==========================================

model Team {
  id              String   @id @default(cuid())
  name            String
  tag             String?  // Team tag/abbreviation
  description     String?
  logo            String?
  
  // Customization
  bannerImage     String?
  primaryColor    String?  @default("#9333ea") // Default purple
  secondaryColor  String?  @default("#6b21a8") // Default darker purple
  
  // Social Links
  websiteUrl      String?
  twitterUrl      String?
  discordUrl      String?
  twitchUrl       String?
  youtubeUrl      String?
  
  // Settings
  isPublic        Boolean  @default(true)
  allowJoinRequests Boolean @default(true)
  maxMembers      Int      @default(10)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  creatorId       String
  creator         User     @relation("TeamCreator", fields: [creatorId], references: [id])
  
  members         TeamMember[]
  registrations   EventRegistration[]
  invites         TeamInvite[]
  
  @@map("teams")
}

model TeamMember {
  id              String   @id @default(cuid())
  role            TeamMemberRole @default(MEMBER)
  
  // Timestamps
  joinedAt        DateTime @default(now())
  
  // Relations
  teamId          String
  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
  @@map("team_members")
}

enum TeamMemberRole {
  CAPTAIN
  CO_CAPTAIN
  MEMBER
}

model TeamInvite {
  id              String   @id @default(cuid())
  
  // Invite Status
  status          TeamInviteStatus @default(PENDING)
  
  // Optional message from inviter
  message         String?
  
  // Expiration
  expiresAt       DateTime
  
  // Response
  respondedAt     DateTime?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  teamId          String
  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
  @@index([userId, status])
  @@index([expiresAt])
  @@map("team_invites")
}

enum TeamInviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}

// ==========================================
// Seat Management
// ==========================================

model Seat {
  id              String   @id @default(cuid())
  
  // Seat Identification
  row             String   // e.g., "A", "B", "C"
  number          Int      // Seat number in row
  label           String   // Display label e.g., "A1", "B5"
  
  // Seat Type
  type            SeatType @default(STANDARD)
  
  // Position (for visual layout)
  positionX       Float?   // X coordinate for seat map
  positionY       Float?   // Y coordinate for seat map
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  eventId         String
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  reservations    SeatReservation[]
  
  @@unique([eventId, row, number])
  @@map("seats")
}

enum SeatType {
  STANDARD
  VIP
  WHEELCHAIR_ACCESSIBLE
  RESERVED
}

model SeatReservation {
  id              String   @id @default(cuid())
  
  // Reservation Status
  status          ReservationStatus @default(RESERVED)
  
  // Timestamps
  reservedAt      DateTime @default(now())
  updatedAt       DateTime @updatedAt
  expiresAt       DateTime? // For temporary holds
  
  // Relations
  seatId          String
  seat            Seat     @relation(fields: [seatId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([seatId])
  @@map("seat_reservations")
}

enum ReservationStatus {
  RESERVED
  CONFIRMED
  CANCELLED
  EXPIRED
}

// ==========================================
// Bracket Management
// ==========================================

model Bracket {
  id              String   @id @default(cuid())
  
  // Bracket Configuration
  name            String
  type            BracketType @default(SINGLE_ELIMINATION)
  status          BracketStatus @default(NOT_STARTED)
  
  // Bracket Settings
  roundCount      Int      // Total number of rounds
  currentRound    Int      @default(1)
  thirdPlaceMatch Boolean  @default(false) // Include 3rd place match
  
  // Metadata
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  eventId         String
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  matches         BracketMatch[]
  participants    BracketParticipant[]
  
  @@map("brackets")
}

enum BracketType {
  SINGLE_ELIMINATION
  DOUBLE_ELIMINATION
  ROUND_ROBIN
  SWISS
}

enum BracketStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model BracketMatch {
  id              String   @id @default(cuid())
  
  // Match Identification
  round           Int      // Which round (1, 2, 3, etc.)
  matchNumber     Int      // Match number within round
  position        Int      // Position in bracket (for ordering)
  
  // Match Type
  isWinnersBracket Boolean @default(true) // For double elimination
  isThirdPlace    Boolean @default(false)
  
  // Match State
  status          MatchStatus @default(PENDING)
  
  // Participants (can be null if waiting for previous matches)
  participant1Id  String?
  participant1    BracketParticipant? @relation("Participant1", fields: [participant1Id], references: [id])
  
  participant2Id  String?
  participant2    BracketParticipant? @relation("Participant2", fields: [participant2Id], references: [id])
  
  // Results
  winnerId        String?
  winner          BracketParticipant? @relation("Winner", fields: [winnerId], references: [id])
  
  score1          Int?     // Score for participant 1
  score2          Int?     // Score for participant 2
  
  // Next Match References
  nextMatchId     String?  // Winner goes to this match
  nextMatch       BracketMatch? @relation("NextMatch", fields: [nextMatchId], references: [id])
  previousMatches BracketMatch[] @relation("NextMatch")
  
  nextMatchLosersBracket String? // For double elimination losers
  
  // Schedule
  scheduledTime   DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  bracketId       String
  bracket         Bracket  @relation(fields: [bracketId], references: [id], onDelete: Cascade)
  
  @@map("bracket_matches")
}

enum MatchStatus {
  PENDING
  READY
  IN_PROGRESS
  COMPLETED
  BYE
}

model BracketParticipant {
  id              String   @id @default(cuid())
  
  // Participant Details
  seed            Int      // Seeding position
  name            String   // Display name (username or team name)
  
  // Participant Type
  isTeam          Boolean  @default(false)
  
  // User or Team Reference
  userId          String?
  teamId          String?
  
  // Stats
  wins            Int      @default(0)
  losses          Int      @default(0)
  finalPlacement  Int?     // Final ranking in tournament
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  bracketId       String
  bracket         Bracket  @relation(fields: [bracketId], references: [id], onDelete: Cascade)
  
  matchesAsParticipant1 BracketMatch[] @relation("Participant1")
  matchesAsParticipant2 BracketMatch[] @relation("Participant2")
  matchesWon            BracketMatch[] @relation("Winner")
  
  @@unique([bracketId, seed])
  @@map("bracket_participants")
}

// ==========================================
// Analytics & Transactions
// ==========================================

model Transaction {
  id              String   @id @default(cuid())
  
  // Transaction Details
  type            TransactionType
  amount          Float
  currency        String   @default("USD")
  
  // Payment Provider Info
  provider        String?  // e.g., "stripe", "paypal"
  providerId      String?  // External transaction ID
  
  // Status
  status          TransactionStatus @default(PENDING)
  
  // Relations
  userId          String
  eventId         String?
  registrationId  String?
  
  // Metadata
  metadata        Json?    // Additional data as needed
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime?
  
  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

enum TransactionType {
  REGISTRATION_FEE
  REFUND
  PRIZE_PAYOUT
  OTHER
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// ==========================================
// Audit Logs
// ==========================================

model AuditLog {
  id              String   @id @default(cuid())
  
  // Action Details
  action          AuditAction
  entityType      String   // e.g., "Event", "User", "Registration"
  entityId        String   // ID of the affected entity
  
  // Actor
  userId          String?  // Who performed the action (null for system)
  userName        String?  // Snapshot of user name
  userRole        String?  // Snapshot of user role
  
  // Change Details
  changes         Json?    // Before/after values
  metadata        Json?    // Additional context
  
  // Request Info
  ipAddress       String?
  userAgent       String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditAction {
  // User Actions
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_ROLE_CHANGED
  
  // Event Actions
  EVENT_CREATED
  EVENT_UPDATED
  EVENT_DELETED
  EVENT_PUBLISHED
  EVENT_CANCELLED
  
  // Registration Actions
  REGISTRATION_APPROVED
  REGISTRATION_REJECTED
  REGISTRATION_CANCELLED
  REGISTRATION_CHECKED_IN
  
  // Payment Actions
  PAYMENT_RECEIVED
  REFUND_ISSUED
  REFUND_REQUESTED
  
  // Bracket Actions
  BRACKET_CREATED
  BRACKET_STARTED
  BRACKET_COMPLETED
  MATCH_UPDATED
  
  // Team Actions
  TEAM_CREATED
  TEAM_UPDATED
  TEAM_DELETED
  MEMBER_ADDED
  MEMBER_REMOVED
  
  // System Actions
  SYSTEM_ERROR
  SECURITY_ALERT
  DATA_EXPORT
}

// ==========================================
// Communication System
// ==========================================

model Notification {
  id              String   @id @default(cuid())
  
  // Notification Details
  type            NotificationType
  title           String
  message         String   @db.Text
  
  // Status
  read            Boolean  @default(false)
  readAt          DateTime?
  
  // Links
  link            String?  // URL to navigate when clicked
  
  // Related Entities
  eventId         String?
  registrationId  String?
  teamId          String?
  
  // Metadata
  metadata        Json?    // Additional data
  
  // Timestamps
  createdAt       DateTime @default(now())
  
  // Relations
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  REGISTRATION_CONFIRMED
  REGISTRATION_APPROVED
  REGISTRATION_REJECTED
  EVENT_REMINDER
  EVENT_UPDATED
  EVENT_CANCELLED
  BRACKET_CREATED
  MATCH_SCHEDULED
  MATCH_RESULT
  TEAM_INVITATION
  TEAM_ACCEPTED
  PAYMENT_RECEIVED
  REFUND_PROCESSED
  ANNOUNCEMENT
  SYSTEM
}

model Announcement {
  id              String   @id @default(cuid())
  
  // Announcement Details
  title           String
  content         String   @db.Text
  priority        AnnouncementPriority @default(NORMAL)
  
  // Targeting
  targetAudience  AnnouncementAudience @default(ALL_USERS)
  eventId         String?  // If targeted to specific event
  
  // Display Settings
  startDate       DateTime @default(now())
  endDate         DateTime?
  isActive        Boolean  @default(true)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  creatorId       String
  creator         User     @relation("AnnouncementCreator", fields: [creatorId], references: [id])
  
  @@index([isActive, startDate, endDate])
  @@index([eventId])
  @@map("announcements")
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AnnouncementAudience {
  ALL_USERS
  ADMINS_ONLY
  ORGANIZERS
  EVENT_PARTICIPANTS
  REGISTERED_USERS
}

model EmailTemplate {
  id              String   @id @default(cuid())
  
  // Template Details
  name            String   @unique
  subject         String
  bodyHtml        String   @db.Text
  bodyText        String   @db.Text
  
  // Template Variables (for documentation)
  variables       Json?    // List of available variables
  
  // Status
  isActive        Boolean  @default(true)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("email_templates")
}

model EmailLog {
  id              String   @id @default(cuid())
  
  // Email Details
  to              String
  from            String
  subject         String
  template        String?  // Template name if used
  
  // Status
  status          EmailStatus @default(PENDING)
  error           String?
  
  // Provider Info
  provider        String?  // e.g., "resend", "sendgrid"
  providerId      String?  // External email ID
  
  // Metadata
  metadata        Json?
  
  // Timestamps
  createdAt       DateTime @default(now())
  sentAt          DateTime?
  
  @@index([to])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}
